import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
export class NgxImageZoomService {
    constructor(changeDetectorRef) {
        this.changeDetectorRef = changeDetectorRef;
        this.zoomDisplay = 'none';
        this.thumbWidth = 0;
        this.thumbHeight = 0;
        this.fullImageTop = 0;
        this.fullImageLeft = 0;
        this.lensWidth = 100;
        this.lensHeight = 100;
        this.lensTop = 0;
        this.lensLeft = 0;
        this.magnifiedWidth = 0;
        this.magnifiedHeight = 0;
        this.zoomPosition = new BehaviorSubject(null);
        this.zoomingEnabled = false;
        this.isReady = false;
        this.enableLens = false;
        this.minZoomRatio = 1;
        this.maxZoomRatio = 2;
        this.magnification = 1;
        this.fullWidth = 0;
        this.fullHeight = 0;
        this.xRatio = 0;
        this.yRatio = 0;
        this.latestMouseLeft = -1;
        this.latestMouseTop = -1;
    }
    zoomOn(event) {
        if (this.isReady) {
            this.zoomingEnabled = true;
            this.calculateRatioAndOffset();
            this.zoomDisplay = 'block';
            this.calculateZoomPosition(event);
            this.changeDetectorRef.markForCheck();
        }
    }
    zoomOff() {
        this.zoomingEnabled = false;
        this.zoomDisplay = 'none';
        this.changeDetectorRef.markForCheck();
    }
    markForCheck() {
        this.changeDetectorRef.markForCheck();
    }
    calculateRatioAndOffset() {
        // If lens is disabled, set lens size to equal thumb size and position it on top of the thumb
        if (!this.enableLens) {
            this.lensWidth = this.thumbWidth;
            this.lensHeight = this.thumbHeight;
            this.lensLeft = 0;
            this.lensTop = 0;
        }
        if (this.fullImageLoaded) {
            this.baseRatio = Math.max(this.thumbWidth / this.fullWidth, this.thumbHeight / this.fullHeight);
            // Don't allow zooming to smaller than thumbnail size
            this.minZoomRatio = Math.max(this.minZoomRatio || 0, this.baseRatio || 0);
            this.calculateRatio();
        }
    }
    calculateRatio() {
        this.magnifiedWidth = this.fullWidth * this.magnification;
        this.magnifiedHeight = this.fullHeight * this.magnification;
        this.xRatio = (this.magnifiedWidth - this.thumbWidth) / this.thumbWidth;
        this.yRatio = (this.magnifiedHeight - this.thumbHeight) / this.thumbHeight;
    }
    calculateZoomPosition(event) {
        const newLeft = Math.max(Math.min(event.offsetX, this.thumbWidth), 0);
        const newTop = Math.max(Math.min(event.offsetY, this.thumbHeight), 0);
        this.setZoomPosition(newLeft, newTop);
        this.calculateImageAndLensPosition();
        this.changeDetectorRef.markForCheck();
    }
    calculateImageAndLensPosition() {
        let lensLeftMod = 0;
        let lensTopMod = 0;
        if (this.enableLens && this.latestMouseLeft > 0) {
            lensLeftMod = this.latestMouseLeft - this.lensWidth / 2;
            lensTopMod = this.latestMouseTop - this.lensHeight / 2;
            this.lensLeft = lensLeftMod;
            this.lensTop = lensTopMod;
        }
        this.fullImageLeft = this.latestMouseLeft * -this.xRatio - lensLeftMod;
        this.fullImageTop = this.latestMouseTop * -this.yRatio - lensTopMod;
    }
    setZoomPosition(left, top) {
        this.latestMouseLeft = Number(left) || this.latestMouseLeft;
        this.latestMouseTop = Number(top) || this.latestMouseTop;
        const newPosition = {
            x: this.latestMouseLeft,
            y: this.latestMouseTop,
        };
        this.zoomPosition.next(newPosition);
    }
}
NgxImageZoomService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.3", ngImport: i0, type: NgxImageZoomService, deps: [{ token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Injectable });
NgxImageZoomService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.3", ngImport: i0, type: NgxImageZoomService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.3", ngImport: i0, type: NgxImageZoomService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWltYWdlLXpvb20uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvbmd4LWltYWdlLXpvb20uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQXFCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDOztBQUl2QyxNQUFNLE9BQU8sbUJBQW1CO0lBK0I1QixZQUFvQixpQkFBb0M7UUFBcEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQTlCakQsZ0JBQVcsR0FBRyxNQUFNLENBQUM7UUFDckIsZUFBVSxHQUFHLENBQUMsQ0FBQztRQUNmLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLGlCQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLGNBQVMsR0FBRyxHQUFHLENBQUM7UUFDaEIsZUFBVSxHQUFHLEdBQUcsQ0FBQztRQUNqQixZQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ1osYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLG9CQUFlLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLGlCQUFZLEdBQUcsSUFBSSxlQUFlLENBQVEsSUFBSSxDQUFDLENBQUM7UUFFaEQsbUJBQWMsR0FBRyxLQUFLLENBQUM7UUFDdkIsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUNoQixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBRW5CLGlCQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLGlCQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBSWxCLGNBQVMsR0FBRyxDQUFDLENBQUM7UUFDZCxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsV0FBTSxHQUFHLENBQUMsQ0FBQztRQUNYLFdBQU0sR0FBRyxDQUFDLENBQUM7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b0hBQW5CLG1CQUFtQjsyRkFBbkIsbUJBQW1CO2tCQUQvQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQ29vcmQgfSBmcm9tICcuL25neC1pbWFnZS16b29tLmNvbXBvbmVudCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ3hJbWFnZVpvb21TZXJ2aWNlIHtcbiAgICBwdWJsaWMgem9vbURpc3BsYXkgPSAnbm9uZSc7XG4gICAgcHVibGljIHRodW1iV2lkdGggPSAwO1xuICAgIHB1YmxpYyB0aHVtYkhlaWdodCA9IDA7XG4gICAgcHVibGljIGZ1bGxJbWFnZVRvcCA9IDA7XG4gICAgcHVibGljIGZ1bGxJbWFnZUxlZnQgPSAwO1xuICAgIHB1YmxpYyBsZW5zV2lkdGggPSAxMDA7XG4gICAgcHVibGljIGxlbnNIZWlnaHQgPSAxMDA7XG4gICAgcHVibGljIGxlbnNUb3AgPSAwO1xuICAgIHB1YmxpYyBsZW5zTGVmdCA9IDA7XG4gICAgcHVibGljIG1hZ25pZmllZFdpZHRoID0gMDtcbiAgICBwdWJsaWMgbWFnbmlmaWVkSGVpZ2h0ID0gMDtcbiAgICBwdWJsaWMgem9vbVBvc2l0aW9uID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb29yZD4obnVsbCk7XG5cbiAgICBwdWJsaWMgem9vbWluZ0VuYWJsZWQgPSBmYWxzZTtcbiAgICBwdWJsaWMgaXNSZWFkeSA9IGZhbHNlO1xuICAgIHB1YmxpYyBlbmFibGVMZW5zID0gZmFsc2U7XG4gICAgcHVibGljIGJhc2VSYXRpbz86IG51bWJlcjtcbiAgICBwdWJsaWMgbWluWm9vbVJhdGlvID0gMTtcbiAgICBwdWJsaWMgbWF4Wm9vbVJhdGlvID0gMjtcbiAgICBwdWJsaWMgbWFnbmlmaWNhdGlvbiA9IDE7XG5cbiAgICBwdWJsaWMgZnVsbEltYWdlTG9hZGVkOiBib29sZWFuO1xuXG4gICAgcHVibGljIGZ1bGxXaWR0aCA9IDA7XG4gICAgcHVibGljIGZ1bGxIZWlnaHQgPSAwO1xuICAgIHByaXZhdGUgeFJhdGlvID0gMDtcbiAgICBwcml2YXRlIHlSYXRpbyA9IDA7XG4gICAgcHJpdmF0ZSBsYXRlc3RNb3VzZUxlZnQgPSAtMTtcbiAgICBwcml2YXRlIGxhdGVzdE1vdXNlVG9wID0gLTE7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNoYW5nZURldGVjdG9yUmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge31cblxuICAgIHB1YmxpYyB6b29tT24oZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNSZWFkeSkge1xuICAgICAgICAgICAgdGhpcy56b29taW5nRW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZVJhdGlvQW5kT2Zmc2V0KCk7XG4gICAgICAgICAgICB0aGlzLnpvb21EaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlWm9vbVBvc2l0aW9uKGV2ZW50KTtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3JSZWYubWFya0ZvckNoZWNrKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgem9vbU9mZigpIHtcbiAgICAgICAgdGhpcy56b29taW5nRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnpvb21EaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB0aGlzLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBtYXJrRm9yQ2hlY2soKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3JSZWYubWFya0ZvckNoZWNrKCk7XG4gICAgfVxuXG4gICAgY2FsY3VsYXRlUmF0aW9BbmRPZmZzZXQoKSB7XG4gICAgICAgIC8vIElmIGxlbnMgaXMgZGlzYWJsZWQsIHNldCBsZW5zIHNpemUgdG8gZXF1YWwgdGh1bWIgc2l6ZSBhbmQgcG9zaXRpb24gaXQgb24gdG9wIG9mIHRoZSB0aHVtYlxuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlTGVucykge1xuICAgICAgICAgICAgdGhpcy5sZW5zV2lkdGggPSB0aGlzLnRodW1iV2lkdGg7XG4gICAgICAgICAgICB0aGlzLmxlbnNIZWlnaHQgPSB0aGlzLnRodW1iSGVpZ2h0O1xuICAgICAgICAgICAgdGhpcy5sZW5zTGVmdCA9IDA7XG4gICAgICAgICAgICB0aGlzLmxlbnNUb3AgPSAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuZnVsbEltYWdlTG9hZGVkKSB7XG4gICAgICAgICAgICB0aGlzLmJhc2VSYXRpbyA9IE1hdGgubWF4KHRoaXMudGh1bWJXaWR0aCAvIHRoaXMuZnVsbFdpZHRoLCB0aGlzLnRodW1iSGVpZ2h0IC8gdGhpcy5mdWxsSGVpZ2h0KTtcblxuICAgICAgICAgICAgLy8gRG9uJ3QgYWxsb3cgem9vbWluZyB0byBzbWFsbGVyIHRoYW4gdGh1bWJuYWlsIHNpemVcbiAgICAgICAgICAgIHRoaXMubWluWm9vbVJhdGlvID0gTWF0aC5tYXgodGhpcy5taW5ab29tUmF0aW8gfHwgMCwgdGhpcy5iYXNlUmF0aW8gfHwgMCk7XG5cbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlUmF0aW8oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNhbGN1bGF0ZVJhdGlvKCkge1xuICAgICAgICB0aGlzLm1hZ25pZmllZFdpZHRoID0gdGhpcy5mdWxsV2lkdGggKiB0aGlzLm1hZ25pZmljYXRpb247XG4gICAgICAgIHRoaXMubWFnbmlmaWVkSGVpZ2h0ID0gdGhpcy5mdWxsSGVpZ2h0ICogdGhpcy5tYWduaWZpY2F0aW9uO1xuXG4gICAgICAgIHRoaXMueFJhdGlvID0gKHRoaXMubWFnbmlmaWVkV2lkdGggLSB0aGlzLnRodW1iV2lkdGgpIC8gdGhpcy50aHVtYldpZHRoO1xuICAgICAgICB0aGlzLnlSYXRpbyA9ICh0aGlzLm1hZ25pZmllZEhlaWdodCAtIHRoaXMudGh1bWJIZWlnaHQpIC8gdGhpcy50aHVtYkhlaWdodDtcbiAgICB9XG5cbiAgICBjYWxjdWxhdGVab29tUG9zaXRpb24oZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgY29uc3QgbmV3TGVmdCA9IE1hdGgubWF4KE1hdGgubWluKGV2ZW50Lm9mZnNldFgsIHRoaXMudGh1bWJXaWR0aCksIDApO1xuICAgICAgICBjb25zdCBuZXdUb3AgPSBNYXRoLm1heChNYXRoLm1pbihldmVudC5vZmZzZXRZLCB0aGlzLnRodW1iSGVpZ2h0KSwgMCk7XG5cbiAgICAgICAgdGhpcy5zZXRab29tUG9zaXRpb24obmV3TGVmdCwgbmV3VG9wKTtcblxuICAgICAgICB0aGlzLmNhbGN1bGF0ZUltYWdlQW5kTGVuc1Bvc2l0aW9uKCk7XG5cbiAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgICB9XG5cbiAgICBjYWxjdWxhdGVJbWFnZUFuZExlbnNQb3NpdGlvbigpIHtcbiAgICAgICAgbGV0IGxlbnNMZWZ0TW9kID0gMDtcbiAgICAgICAgbGV0IGxlbnNUb3BNb2QgPSAwO1xuXG4gICAgICAgIGlmICh0aGlzLmVuYWJsZUxlbnMgJiYgdGhpcy5sYXRlc3RNb3VzZUxlZnQgPiAwKSB7XG4gICAgICAgICAgICBsZW5zTGVmdE1vZCA9IHRoaXMubGF0ZXN0TW91c2VMZWZ0IC0gdGhpcy5sZW5zV2lkdGggLyAyO1xuICAgICAgICAgICAgbGVuc1RvcE1vZCA9IHRoaXMubGF0ZXN0TW91c2VUb3AgLSB0aGlzLmxlbnNIZWlnaHQgLyAyO1xuICAgICAgICAgICAgdGhpcy5sZW5zTGVmdCA9IGxlbnNMZWZ0TW9kO1xuICAgICAgICAgICAgdGhpcy5sZW5zVG9wID0gbGVuc1RvcE1vZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZnVsbEltYWdlTGVmdCA9IHRoaXMubGF0ZXN0TW91c2VMZWZ0ICogLXRoaXMueFJhdGlvIC0gbGVuc0xlZnRNb2Q7XG4gICAgICAgIHRoaXMuZnVsbEltYWdlVG9wID0gdGhpcy5sYXRlc3RNb3VzZVRvcCAqIC10aGlzLnlSYXRpbyAtIGxlbnNUb3BNb2Q7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRab29tUG9zaXRpb24obGVmdDogbnVtYmVyLCB0b3A6IG51bWJlcikge1xuICAgICAgICB0aGlzLmxhdGVzdE1vdXNlTGVmdCA9IE51bWJlcihsZWZ0KSB8fCB0aGlzLmxhdGVzdE1vdXNlTGVmdDtcbiAgICAgICAgdGhpcy5sYXRlc3RNb3VzZVRvcCA9IE51bWJlcih0b3ApIHx8IHRoaXMubGF0ZXN0TW91c2VUb3A7XG5cbiAgICAgICAgY29uc3QgbmV3UG9zaXRpb246IENvb3JkID0ge1xuICAgICAgICAgICAgeDogdGhpcy5sYXRlc3RNb3VzZUxlZnQsXG4gICAgICAgICAgICB5OiB0aGlzLmxhdGVzdE1vdXNlVG9wLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnpvb21Qb3NpdGlvbi5uZXh0KG5ld1Bvc2l0aW9uKTtcbiAgICB9XG59XG4iXX0=